# 仕様書 (SPEC.md)

## 1. 概要 (Overview)
このアプリケーションは、DeepL APIを利用してMarkdownファイルを翻訳するためのコマンドラインツールである。設定ファイルに基づき、ファイルまたはディレクトリ単位で翻訳処理を実行し、Markdownの構造（コードブロック、メタデータ）を維持する。ファイルの更新チェック機能とAPIレート制限への配慮により、効率的かつ安定した翻訳を実現し、処理完了後にはサマリーレポートを出力する。また、デバッグ用の詳細なロギング機能を備える。
## 2. プロダクトバックログ (Product Backlog)

| 優先度 | ユーザーストーリー                                                                                                                              |
| :--- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
| 高     | **As a** 開発者, **I want to** アプリケーションがAPIのレート制限を考慮する, **so that** サービスが中断されたり、予期せぬエラーが発生したりするのを防ぐ。 |
| 高     | **As a** 開発者, **I want to** 変更されたファイルのみを翻訳する, **so that** APIの利用量を節約し、コストを削減できる。                                  |
| 高     | **As a** 開発者, **I want to** 認証キーを環境変数から読み込む, **so that** キーを安全に管理できる。                                               |
| 高     | **As a** コンテンツ管理者, **I want to** 記事内のコードブロックやFrontmatterが翻訳されないようにする, **so that** ドキュメントの技術的な正確性を保つ。 |
| 高     | **As a** 開発者, **I want to** 設定ファイルで翻訳元と翻訳先のペアを複数定義する, **so that** プロジェクト全体の翻訳タスクを一元管理できる。         |
| 中     | **As a** ユーザー, **I want to** 処理完了後に結果のサマリーレポートを受け取る, **so that** 成功、スキップ、失敗の数や消費文字数を素早く把握できる。   |
| 中     | **As a** 開発者, **I want to** ディレクトリを指定して配下の全ファイルを一括で翻訳する, **so that** リリース作業を効率化できる。                       |
| 中     | **As a** コンテンツ管理者, **I want to** 更新した単一のファイルだけを素早く翻訳する, **so that** 変更内容をすぐに確認できる。                         |
| 低     | **As a** 開発者, **I want to** 複数のファイルを並列で翻訳処理する, **so that** 大量のドキュメントを扱う際の待ち時間を短縮できる。                     |

## 3. 要件 (Requirements)

### 3.1. 機能要件
- **CLI**:
    - `translate-markdown`のような単一のコマンドで実行する。
    - `--config <path>`: 設定ファイルのパスを指定できる（デフォルト: `config.toml`）。
    - `--parallel <number>`: 並列実行数を指定できる（オプション）。
    - `--force`: キャッシュを無視して、すべてのファイルを強制的に再翻訳する。
- **デバッグ機能**:
    - 環境変数 `TRANSLATE_DEBUG=1` を設定して実行すると、デバッグレベルの詳細なログ（APIリクエスト/レスポンス等）が出力される。 
    - 通常実行時にエラーが発生した場合、そのエラーに関連する直前のデバッグログも合わせて出力される（Finger Crossed Handler方式）。
- **設定ファイル (`config.toml`)**:
    - TOML形式で記述する。
    - グローバル設定と、複数の翻訳タスク（ジョブ）を定義できる。
    - **グローバル設定**:
        - `target_lang` (必須): 翻訳先の言語コード (例: "EN-US")。
        - `source_lang` (任意): 翻訳元の言語コード (例: "JA")。
    - **ジョブ設定 (`[[jobs]]`)**:
        - `source` (必須): 翻訳元のファイルまたはディレクトリパス。
        - `destination` (必須): 翻訳先のファイルまたはディレクトリパス。
        - `target_lang` (任意): このジョブの翻訳先言語。グローバル設定を上書きする。
        - `source_lang` (任意): このジョブの翻訳元言語。グローバル設定を上書きする。
        - `exclude` (任意): 翻訳対象から除外するファイル/ディレクトリのパターン配列 (例: `["**/drafts/*"]`)。
- **翻訳ロジック**:
    - Markdownファイルをパースし、テキストノードのみを翻訳対象とする。
    - YAML Frontmatter (例: `--- ... ---`) は翻訳しない。
    - コードブロック (`` ``` ``...`` ``` `` や `~~~` ... `~~~`) は翻訳しない。
    - インラインコード (`` ` ``...`` ` ``) は翻訳しない。
    - HTMLタグは翻訳しない。
    - 翻訳の丁寧さ（Formality）は、ですます調に対応する固定値("more")を使用する。
- **更新チェックとキャッシュ機構**:
    - `source`ファイルのMD5ハッシュを計算し、キャッシュ内のハッシュと比較する。
    - ハッシュが一致する場合、API呼び出しをスキップする。
    - 翻訳が成功した場合、`source`ファイルのパスと新しいMD5ハッシュをキャッシュファイル (`.translation_cache.json`) に保存する。
    - `--force`フラグが指定された場合、この更新チェックは行わない。
- **API連携**:
    - DeepL API (Free Plan) を利用する。
    - APIキーは環境変数 `DEEPL_AUTH_KEY` から取得する。
    - **レート制限への配慮**:
        - 翻訳実行前に総文字数を計算し、ユーザーに提示する。
        - API呼び出し間に適切な待機時間を設ける。
        - レート制限エラー(HTTP 429)を受け取った場合、時間を置いてから数回リトライする。
- **完了レポート**:
    - 全ての処理が完了した後、コンソールに以下のサマリーを出力する。
        - 処理対象ファイル総数
        - 翻訳成功ファイル数
        - スキップしたファイル数 (変更なし)
        - 失敗したファイル数
        - 翻訳した総文字数
        - 失敗したファイルとエラー理由の一覧

### 3.2. 非機能要件
- **信頼性 (第1優先)**: 特定のファイルの翻訳に失敗しても、他の処理は継続し、最後にエラーレポートを出力する。
- **使いやすさ (第2優先)**: CLIの操作は直感的で、エラーメッセージや進捗状況が分かりやすく表示される。
- **パフォーマンス (第3優先)**: 大量ファイル処理時の速度も考慮するが、信頼性と使いやすさを優先する。
- **セキュリティ**: APIキーをコードや設定ファイルに含めず、環境変数で管理する。

## 4. 完了の定義 (Definition of Done)
- 実装されたコードが、`CONVENTION.md` に準拠している。
- ユーザーストーリーの受け入れ基準を満たすテストコードが実装され、全てパスしている。
- CI/CDパイプラインが正常に完了する。
- 関連するドキュメント (`README.md`など) が更新されている。

## 5. 準備完了の定義 (Definition of Ready)
- ユーザーストーリーが明確で、開発チームが実装内容を理解できる。
- 受け入れ基準が定義されている。
- 依存関係が特定され、解決されている。
